import{u as I,R as i,d as c,j as e,G as o,B as t,L as v,M as k,T as l,g as b}from"./index-B4XXapqm.js";import{u as M}from"./dexie-react-hooks-C39wFvoC.js";import{e as T,F as B,p as L}from"./exportImport-hqSfzcEj.js";import{T as O}from"./Title-BN9HuS6F.js";import{S as p}from"./Stack-DXppRYmq.js";import{C as P}from"./Card-CV6FZI7P.js";import{A as U}from"./Avatar-BOc0HmdV.js";function X(){const n=M(()=>c.characters.toArray()),[u,s]=I(),[C,E]=i.useState(null),[F,d]=I(!1),[S,g]=i.useState(!1),[w,h]=i.useState(null),[N,y]=i.useState(""),m=i.useRef(null),z=r=>{E(r),s.open()},D=i.useCallback(async()=>{const r=await c.characters.toArray()??[];T("characters",r)},[]),A=r=>{m.current=r,y(r?r.name:""),h(null)},R=async()=>{if(!m.current){h("Select a JSON file before importing.");return}g(!0),h(null);try{const r=await L("characters",m.current);if(r.length===0)throw new Error("Import file does not contain any characters.");const x=r.map(a=>{const j=(a.name??"").trim();return{id:(typeof a.id=="string"?a.id.trim():"")||b(),name:j||"Unnamed Character",inChatName:(a.inChatName??j??"Character").trim()||j||"Character",avatar:a.avatar,description:a.description??"",initMessage:a.initMessage??"",scenario:a.scenario??"",lorebookIds:Array.isArray(a.lorebookIds)?a.lorebookIds:[]}}),f=new Map;for(const a of x)f.has(a.id)&&(a.id=b()),f.set(a.id,a);await c.transaction("rw",c.characters,async()=>{await c.characters.bulkPut(Array.from(f.values()))}),d.close(),y(""),m.current=null}catch(r){const x=r instanceof Error?r.message:"Failed to import characters.";h(x)}finally{g(!1)}};return e.jsxs(i.Fragment,{children:[e.jsxs(o,{justify:"space-between",align:"end",mb:"md",children:[e.jsx(O,{order:2,children:"Characters"}),e.jsxs(o,{gap:"xs",children:[e.jsx(t,{variant:"default",onClick:D,children:"Export"}),e.jsx(t,{variant:"default",onClick:d.open,children:"Import"}),e.jsx(t,{component:v,to:"/character/new/",children:"New Character"})]})]}),e.jsx(p,{gap:"xs",children:n?.map(r=>e.jsx(G,{c:r,onDelete:()=>z(r.id)},r.id))}),e.jsxs(k,{opened:u,onClose:s.close,title:"Delete Character",children:["Are you sure you want to delete this character?",e.jsxs(o,{mt:"md",justify:"flex-end",children:[e.jsx(t,{variant:"default",onClick:s.close,children:"Cancel"}),e.jsx(t,{color:"red",onClick:async()=>{C&&await c.characters.delete(C),s.close()},children:"Delete"})]})]}),e.jsx(k,{opened:F,onClose:d.close,title:"Import Characters",children:e.jsxs(p,{children:[e.jsx(l,{size:"sm",children:"Import characters from a JSON export file. Existing characters with the same identifier will be overwritten."}),e.jsxs(o,{justify:"space-between",align:"center",children:[e.jsx(B,{onChange:A,accept:"application/json",children:r=>e.jsx(t,{...r,variant:"default",size:"compact-sm",children:"Choose File"})}),e.jsx(l,{size:"sm",c:"dimmed",children:N||"No file selected"})]}),w&&e.jsx(l,{size:"sm",c:"red",children:w}),e.jsxs(o,{justify:"flex-end",mt:"sm",children:[e.jsx(t,{variant:"default",onClick:d.close,children:"Cancel"}),e.jsx(t,{onClick:R,loading:S,children:"Import"})]})]})})]})}function G({c:n,onDelete:u}){return e.jsx(P,{radius:"md",p:"md",withBorder:!0,style:{backdropFilter:"saturate(180%) blur(20px)",backgroundColor:"rgba(0, 0, 0, 0.3)"},children:e.jsxs(o,{justify:"space-between",children:[e.jsxs(o,{wrap:"nowrap",children:[e.jsx(U,{radius:"xl",src:n.avatar,alt:n.name,size:"lg"}),e.jsxs(p,{gap:4,children:[e.jsx(l,{fw:600,children:n.name}),e.jsx(l,{size:"sm",c:"dimmed",children:n.inChatName})]})]}),e.jsxs(p,{gap:"xs",children:[e.jsx(t,{onClick:s=>{s.stopPropagation()},component:v,to:`/character/${n.id}`,size:"compact-xs",children:"Edit"}),e.jsx(t,{size:"compact-xs",color:"red",onClick:s=>{s.preventDefault(),s.stopPropagation(),u()},children:"Delete"})]})]})})}export{X as component};
