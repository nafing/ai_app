import{v as be,b as ne,i as pe,F as Se,j as e,h as oe,H as Ue,k as me,z as fe,p as We,r as d,I as Ee,J as ze,K as Xe,O as Be,Q as Ke,U as Fe,e as _e,V as Oe,W as xe,X as Ve,A as Qe,Y as Ze,Z as Je,_ as et,$ as tt,a0 as st,a1 as at,a2 as nt,a3 as ot,a4 as rt,a5 as it,a6 as ke,a7 as lt,a8 as ye,w as ct,a9 as dt,t as Pe,aa as Re,ab as ut,ac as Z,G,T as V,ad as ae,P as ht,R as pt,ae as mt,B as ue,af as Le,ag as ft,d as x,ah as gt,g as K,ai as vt,M as yt}from"./index-B4XXapqm.js";import{u as $e}from"./dexie-react-hooks-C39wFvoC.js";import{S as Q}from"./Stack-DXppRYmq.js";import{A as xt}from"./Avatar-BOc0HmdV.js";import{T as bt}from"./Textarea-rudQuP3u.js";var qe={root:"m_66836ed3",wrapper:"m_a5d60502",body:"m_667c2793",title:"m_6a03f287",label:"m_698f4f23",icon:"m_667f2a6a",message:"m_7fa78076",closeButton:"m_87f54839"};const wt=me((a,{radius:t,color:s,variant:r,autoContrast:u})=>{const v=a.variantColorResolver({color:s||a.primaryColor,theme:a,variant:r||"light",autoContrast:u});return{root:{"--alert-radius":t===void 0?void 0:fe(t),"--alert-bg":s||r?v.background:void 0,"--alert-color":v.color,"--alert-bd":s||r?v.border:void 0}}}),he=be((a,t)=>{const s=ne("Alert",null,a),{classNames:r,className:u,style:v,styles:w,unstyled:M,vars:m,radius:y,color:n,title:j,children:P,id:l,icon:b,withCloseButton:f,onClose:R,closeButtonLabel:i,variant:k,autoContrast:S,role:g,attributes:C,...$}=s,T=pe({name:"Alert",classes:qe,props:s,className:u,style:v,classNames:r,styles:w,unstyled:M,attributes:C,vars:m,varsResolver:wt}),F=Se(l),D=j&&`${F}-title`||void 0,_=`${F}-body`;return e.jsx(oe,{id:F,...T("root",{variant:k}),variant:k,ref:t,role:g||"alert",...$,"aria-describedby":P?_:void 0,"aria-labelledby":j?D:void 0,children:e.jsxs("div",{...T("wrapper"),children:[b&&e.jsx("div",{...T("icon"),children:b}),e.jsxs("div",{...T("body"),children:[j&&e.jsx("div",{...T("title"),"data-with-close-button":f||void 0,children:e.jsx("span",{id:D,...T("label"),children:j})}),P&&e.jsx("div",{id:_,...T("message"),"data-variant":k,children:P})]}),f&&e.jsx(Ue,{...T("closeButton"),onClick:R,variant:"transparent",size:16,iconSize:16,"aria-label":i,unstyled:M})]})})});he.classes=qe;he.displayName="@mantine/core/Alert";var Ge={root:"m_9e117634"};const jt=me((a,{radius:t,fit:s})=>({root:{"--image-radius":t===void 0?void 0:fe(t),"--image-object-fit":s}})),we=We((a,t)=>{const s=ne("Image",null,a),{classNames:r,className:u,style:v,styles:w,unstyled:M,vars:m,onError:y,src:n,radius:j,fit:P,fallbackSrc:l,mod:b,attributes:f,...R}=s,[i,k]=d.useState(!n);d.useEffect(()=>k(!n),[n]);const S=pe({name:"Image",classes:Ge,props:s,className:u,style:v,classNames:r,styles:w,unstyled:M,attributes:f,vars:m,varsResolver:jt});return i&&l?e.jsx(oe,{component:"img",ref:t,src:l,...S("root"),onError:y,mod:["fallback",b],...R}):e.jsx(oe,{component:"img",ref:t,...S("root"),src:n,onError:g=>{y?.(g),k(!0)},mod:b,...R})});we.classes=Ge;we.displayName="@mantine/core/Image";const Ct={duration:100,transition:"fade"};function De(a,t){return{...Ct,...t,...a}}function It({offset:a,position:t,defaultOpened:s}){const[r,u]=d.useState(s),v=d.useRef(null),{x:w,y:M,elements:m,refs:y,update:n,placement:j}=Ee({placement:t,middleware:[ze({crossAxis:!0,padding:5,rootBoundary:"document"})]}),P=j.includes("right")?a:t.includes("left")?a*-1:0,l=j.includes("bottom")?a:t.includes("top")?a*-1:0,b=d.useCallback(({clientX:f,clientY:R})=>{y.setPositionReference({getBoundingClientRect(){return{width:0,height:0,x:f,y:R,left:f+P,top:R+l,right:f,bottom:R}}})},[m.reference]);return d.useEffect(()=>{if(y.floating.current){const f=v.current;f.addEventListener("mousemove",b);const R=Xe(y.floating.current);return R.forEach(i=>{i.addEventListener("scroll",n)}),()=>{f.removeEventListener("mousemove",b),R.forEach(i=>{i.removeEventListener("scroll",n)})}}},[m.reference,y.floating.current,n,b,r]),{handleMouseMove:b,x:w,y:M,opened:r,setOpened:u,boundaryRef:v,floating:y.setFloating}}var ge={tooltip:"m_1b3c8819",arrow:"m_f898399f"};const Mt={refProp:"ref",withinPortal:!0,offset:10,position:"right",zIndex:Be("popover")},kt=me((a,{radius:t,color:s})=>({tooltip:{"--tooltip-radius":t===void 0?void 0:fe(t),"--tooltip-bg":s?Qe(s,a):void 0,"--tooltip-color":s?"var(--mantine-color-white)":void 0}})),je=be((a,t)=>{const s=ne("TooltipFloating",Mt,a),{children:r,refProp:u,withinPortal:v,style:w,className:M,classNames:m,styles:y,unstyled:n,radius:j,color:P,label:l,offset:b,position:f,multiline:R,zIndex:i,disabled:k,defaultOpened:S,variant:g,vars:C,portalProps:$,attributes:T,...F}=s,D=Ke(),_=pe({name:"TooltipFloating",props:s,classes:ge,className:M,style:w,classNames:m,styles:y,unstyled:n,attributes:T,rootSelector:"tooltip",vars:C,varsResolver:kt}),{handleMouseMove:O,x:J,y:H,opened:ee,boundaryRef:z,floating:re,setOpened:te}=It({offset:b,position:f,defaultOpened:S});if(!Fe(r))throw new Error("[@mantine/core] Tooltip.Floating component children should be an element or a component that accepts ref, fragments, strings, numbers and other primitive values are not supported");const ie=_e(z,Oe(r),t),U=r.props,se=L=>{U.onMouseEnter?.(L),O(L),te(!0)},Y=L=>{U.onMouseLeave?.(L),te(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(xe,{...$,withinPortal:v,children:e.jsx(oe,{...F,..._("tooltip",{style:{...Ve(w,D),zIndex:i,display:!k&&ee?"block":"none",top:(H&&Math.round(H))??"",left:(J&&Math.round(J))??""}}),variant:g,ref:re,mod:{multiline:R},children:l})}),d.cloneElement(r,{...U,[u]:ie,onMouseEnter:se,onMouseLeave:Y})]})});je.classes=ge;je.displayName="@mantine/core/TooltipFloating";const He=d.createContext(!1),Pt=He.Provider,Rt=()=>d.useContext(He),$t={openDelay:0,closeDelay:0};function Ce(a){const{openDelay:t,closeDelay:s,children:r}=ne("TooltipGroup",$t,a);return e.jsx(Pt,{value:!0,children:e.jsx(Ze,{delay:{open:t,close:s},children:r})})}Ce.displayName="@mantine/core/TooltipGroup";Ce.extend=a=>a;function Dt(a){if(a===void 0)return{shift:!0,flip:!0};const t={...a};return a.shift===void 0&&(t.shift=!0),a.flip===void 0&&(t.flip=!0),t}function Tt(a){const t=Dt(a.middlewares),s=[it(a.offset)];return t.shift&&s.push(ze(typeof t.shift=="boolean"?{padding:8}:{padding:8,...t.shift})),t.flip&&s.push(typeof t.flip=="boolean"?ke():ke(t.flip)),s.push(lt({element:a.arrowRef,padding:a.arrowOffset})),t.inline?s.push(typeof t.inline=="boolean"?ye():ye(t.inline)):a.inline&&s.push(ye()),s}function At(a){const[t,s]=d.useState(a.defaultOpened),u=typeof a.opened=="boolean"?a.opened:t,v=Rt(),w=Se(),M=d.useCallback(C=>{s(C),C&&i(w)},[w]),{x:m,y,context:n,refs:j,placement:P,middlewareData:{arrow:{x:l,y:b}={}}}=Ee({strategy:a.strategy,placement:a.position,open:u,onOpenChange:M,middleware:Tt(a),whileElementsMounted:et}),{delay:f,currentId:R,setCurrentId:i}=Je(n,{id:w}),{getReferenceProps:k,getFloatingProps:S}=tt([st(n,{enabled:a.events?.hover,delay:v?f:{open:a.openDelay,close:a.closeDelay},mouseOnly:!a.events?.touch}),at(n,{enabled:a.events?.focus,visibleOnly:!0}),nt(n,{role:"tooltip"}),ot(n,{enabled:typeof a.opened>"u"})]);rt(()=>{a.onPositionChange?.(P)},[P]);const g=u&&R&&R!==w;return{x:m,y,arrowX:l,arrowY:b,reference:j.setReference,floating:j.setFloating,getFloatingProps:S,getReferenceProps:k,isGroupPhase:g,opened:u,placement:P}}const Te={position:"top",refProp:"ref",withinPortal:!0,arrowSize:4,arrowOffset:5,arrowRadius:0,arrowPosition:"side",offset:5,transitionProps:{duration:100,transition:"fade"},events:{hover:!0,focus:!1,touch:!1},zIndex:Be("popover"),positionDependencies:[],middlewares:{flip:!0,shift:!0,inline:!1}},Nt=me((a,{radius:t,color:s,variant:r,autoContrast:u})=>{const v=a.variantColorResolver({theme:a,color:s||a.primaryColor,autoContrast:u,variant:r||"filled"});return{tooltip:{"--tooltip-radius":t===void 0?void 0:fe(t),"--tooltip-bg":s?v.background:void 0,"--tooltip-color":s?v.color:void 0}}}),q=be((a,t)=>{const s=ne("Tooltip",Te,a),{children:r,position:u,refProp:v,label:w,openDelay:M,closeDelay:m,onPositionChange:y,opened:n,defaultOpened:j,withinPortal:P,radius:l,color:b,classNames:f,styles:R,unstyled:i,style:k,className:S,withArrow:g,arrowSize:C,arrowOffset:$,arrowRadius:T,arrowPosition:F,offset:D,transitionProps:_,multiline:O,events:J,zIndex:H,disabled:ee,positionDependencies:z,onClick:re,onMouseEnter:te,onMouseLeave:ie,inline:U,variant:se,keepMounted:Y,vars:L,portalProps:le,mod:W,floatingStrategy:ce,middlewares:ve,autoContrast:Ie,attributes:o,target:c,...p}=ne("Tooltip",Te,s),{dir:A}=ct(),B=d.useRef(null),h=At({position:dt(A,u),closeDelay:m,openDelay:M,onPositionChange:y,opened:n,defaultOpened:j,events:J,arrowRef:B,arrowOffset:$,offset:typeof D=="number"?D+(g?C/2:0):D,positionDependencies:[...z,c??r],inline:U,strategy:ce,middlewares:ve});d.useEffect(()=>{const X=c instanceof HTMLElement?c:typeof c=="string"?document.querySelector(c):c?.current||null;X&&h.reference(X)},[c,h]);const E=pe({name:"Tooltip",props:s,classes:ge,className:S,style:k,classNames:f,styles:R,unstyled:i,attributes:o,rootSelector:"tooltip",vars:L,varsResolver:Nt});if(!c&&!Fe(r))return null;if(c){const X=De(_,{duration:100,transition:"fade"});return e.jsx(e.Fragment,{children:e.jsx(xe,{...le,withinPortal:P,children:e.jsx(Pe,{...X,keepMounted:Y,mounted:!ee&&!!h.opened,duration:h.isGroupPhase?10:X.duration,children:Ye=>e.jsxs(oe,{...p,"data-fixed":ce==="fixed"||void 0,variant:se,mod:[{multiline:O},W],...h.getFloatingProps({ref:h.floating,className:E("tooltip").className,style:{...E("tooltip").style,...Ye,zIndex:H,top:h.y??0,left:h.x??0}}),children:[w,e.jsx(Re,{ref:B,arrowX:h.arrowX,arrowY:h.arrowY,visible:g,position:h.placement,arrowSize:C,arrowOffset:$,arrowRadius:T,arrowPosition:F,...E("arrow")})]})})})})}const N=r,I=N.props,de=_e(h.reference,Oe(N),t),Me=De(_,{duration:100,transition:"fade"});return e.jsxs(e.Fragment,{children:[e.jsx(xe,{...le,withinPortal:P,children:e.jsx(Pe,{...Me,keepMounted:Y,mounted:!ee&&!!h.opened,duration:h.isGroupPhase?10:Me.duration,children:X=>e.jsxs(oe,{...p,"data-fixed":ce==="fixed"||void 0,variant:se,mod:[{multiline:O},W],...h.getFloatingProps({ref:h.floating,className:E("tooltip").className,style:{...E("tooltip").style,...X,zIndex:H,top:h.y??0,left:h.x??0}}),children:[w,e.jsx(Re,{ref:B,arrowX:h.arrowX,arrowY:h.arrowY,visible:g,position:h.placement,arrowSize:C,arrowOffset:$,arrowRadius:T,arrowPosition:F,...E("arrow")})]})})}),d.cloneElement(N,h.getReferenceProps({onClick:re,onMouseEnter:te,onMouseLeave:ie,onMouseMove:s.onMouseMove,onPointerDown:s.onPointerDown,onPointerEnter:s.onPointerEnter,className:ut(S,I.className),...I,[v]:de}))]})});q.classes=ge;q.displayName="@mantine/core/Tooltip";q.Floating=je;q.Group=Ce;const St=[["path",{d:"M15 6l-6 6l6 6",key:"svg-0"}]],Et=Z("outline","chevron-left","ChevronLeft",St);const zt=[["path",{d:"M9 6l6 6l-6 6",key:"svg-0"}]],Bt=Z("outline","chevron-right","ChevronRight",zt);const Ft=[["path",{d:"M7 18m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0",key:"svg-0"}],["path",{d:"M7 6m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0",key:"svg-1"}],["path",{d:"M17 6m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0",key:"svg-2"}],["path",{d:"M7 8l0 8",key:"svg-3"}],["path",{d:"M9 18h6a2 2 0 0 0 2 -2v-5",key:"svg-4"}],["path",{d:"M14 14l3 -3l3 3",key:"svg-5"}]],_t=Z("outline","git-branch","GitBranch",Ft);const Ot=[["path",{d:"M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0",key:"svg-0"}],["path",{d:"M12 9h.01",key:"svg-1"}],["path",{d:"M11 12h1v4h1",key:"svg-2"}]],Ae=Z("outline","info-circle","InfoCircle",Ot);const Lt=[["path",{d:"M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4",key:"svg-0"}],["path",{d:"M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4",key:"svg-1"}]],qt=Z("outline","refresh","Refresh",Lt);const Gt=[["path",{d:"M10 14l11 -11",key:"svg-0"}],["path",{d:"M21 3l-6.5 18a.55 .55 0 0 1 -1 0l-3.5 -7l-7 -3.5a.55 .55 0 0 1 0 -1l18 -6.5",key:"svg-1"}]],Ht=Z("outline","send","Send",Gt);const Yt=[["path",{d:"M4 7l16 0",key:"svg-0"}],["path",{d:"M10 11l0 6",key:"svg-1"}],["path",{d:"M14 11l0 6",key:"svg-2"}],["path",{d:"M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12",key:"svg-3"}],["path",{d:"M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3",key:"svg-4"}]],Ut=Z("outline","trash","Trash",Yt),Wt=({text:a,time:t,fromMe:s=!1,avatarUrl:r,name:u,onDelete:v,onRegenerate:w,onCreateBranch:M,onNavigateBranch:m,branchLabel:y,canNavigatePrev:n=!1,canNavigateNext:j=!1})=>{const P=d.useMemo(()=>u?.trim()?.[0]?.toUpperCase()??void 0,[u]),l=d.useMemo(()=>{const f=(i,k,S)=>i.split(/\r?\n/g).flatMap((g,C)=>{const $=[];return C>0&&$.push(e.jsx("br",{},`${S}-br-${C}`)),$.push(k(g,C)),$});return a.split(/(!\[[^\]]*\]\([^)]+\)|\*[^*]+\*|"[^"]+")/g).flatMap((i,k)=>{if(!i)return[];const S=i.match(/^!\[([^\]]*)\]\(([^)]+)\)$/);if(S){const[,g,C]=S;return[e.jsx(we,{src:C,alt:g||"Image",radius:"md",fit:"contain",maw:260,loading:"lazy",style:{maxWidth:"100%"}},`image-${k}`)]}if(i.startsWith('"')&&i.endsWith('"')){const C=`"${i.slice(1,-1)}"`;return f(C,($,T)=>e.jsx("span",{style:{fontWeight:600},children:$},`quote-${k}-${T}`),`quote-${k}`)}if(i.startsWith("*")&&i.endsWith("*")){const g=i.slice(1,-1);return f(g,(C,$)=>e.jsx("span",{style:{color:"var(--mantine-color-dimmed)",fontStyle:"italic"},children:C},`asterisk-${k}-${$}`),`asterisk-${k}`)}return f(i,(g,C)=>e.jsx(pt.Fragment,{children:g},`plain-${k}-${C}`),`plain-${k}`)})},[a]),b=f=>e.jsx(xt,{src:r,radius:"xl",size:28,alt:u,children:!r&&P},`${u}-${f}`);return e.jsxs(G,{justify:s?"end":"start",align:"end",gap:6,children:[!s&&b("left"),e.jsxs(Q,{align:s?"flex-end":"flex-start",gap:4,maw:"80%",children:[(u||y||v||w||M||m)&&e.jsxs(G,{justify:"space-between",gap:4,w:"100%",children:[e.jsxs(G,{gap:6,align:"center",children:[!s&&u&&e.jsx(V,{size:"xs",c:"dimmed",children:u}),y&&e.jsx(V,{size:"xs",c:"dimmed",children:y})]}),e.jsxs(G,{gap:4,justify:"flex-end",children:[m&&e.jsxs(e.Fragment,{children:[e.jsx(q,{label:"Previous branch",withArrow:!0,children:e.jsx(ae,{size:"sm",variant:"subtle",color:"gray","aria-label":"Previous branch",disabled:!n,onClick:()=>{n&&m("previous")},children:e.jsx(Et,{size:14,stroke:1.5})})}),e.jsx(q,{label:"Next branch",withArrow:!0,children:e.jsx(ae,{size:"sm",variant:"subtle",color:"gray","aria-label":"Next branch",disabled:!j,onClick:()=>{j&&m("next")},children:e.jsx(Bt,{size:14,stroke:1.5})})})]}),M&&e.jsx(q,{label:"Create branch from here",withArrow:!0,children:e.jsx(ae,{size:"sm",variant:"subtle",color:"teal","aria-label":"Create branch",onClick:M,children:e.jsx(_t,{size:14,stroke:1.5})})}),w&&e.jsx(q,{label:"Regenerate message",withArrow:!0,children:e.jsx(ae,{size:"sm",variant:"subtle",color:"blue","aria-label":"Regenerate message",onClick:w,children:e.jsx(qt,{size:14,stroke:1.5})})}),v&&e.jsx(q,{label:"Delete message",withArrow:!0,children:e.jsx(ae,{size:"sm",variant:"subtle",color:"gray","aria-label":"Delete message",onClick:v,children:e.jsx(Ut,{size:14,stroke:1.5})})})]})]}),e.jsx(ht,{radius:16,p:"sm",shadow:"xs",style:{backdropFilter:"saturate(180%) blur(20px)",backgroundColor:"rgba(0, 0, 0, 0.5)",borderTopRightRadius:s?4:16,borderTopLeftRadius:s?16:4},children:e.jsx(V,{size:"sm",style:{whiteSpace:"pre-wrap"},children:l})}),t&&e.jsx(V,{size:"xs",c:"dimmed",children:new Date(t).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),s&&b("right")]})},Xt=({viewport:a,messages:t,characters:s,persona:r,onDeleteMessage:u,onRegenerateMessage:v,onCreateBranch:w,onNavigateBranch:M,branchLabel:m,canNavigatePrev:y,canNavigateNext:n})=>{const j=d.useMemo(()=>[...t??[]].sort((l,b)=>l.timestamp-b.timestamp),[t]),P=d.useMemo(()=>l=>l.avatar?l.avatar:l.role==="user"?r?.avatar??"":l.role==="assistant"?s.find(f=>(f.inChatName||f.name)?.toLowerCase()===l.name?.toLowerCase()||f.name?.toLowerCase()===l.name?.toLowerCase())?.avatar??"":"",[s,r?.avatar]);return e.jsx(mt,{scrollbarSize:4,type:"never",viewportRef:a,children:e.jsx(Q,{gap:"xs",py:"xs",children:j.length===0?e.jsx(V,{size:"sm",c:"dimmed",ta:"center",children:"Start the conversation by sending a message."}):j.map(l=>e.jsx(Wt,{text:l.content,time:l.timestamp,fromMe:l.role==="user",name:l.name,avatarUrl:P(l),onDelete:()=>u(l),onRegenerate:l.role==="assistant"&&v?()=>v(l):void 0,onCreateBranch:w?()=>w(l):void 0,onNavigateBranch:M,branchLabel:m,canNavigatePrev:y,canNavigateNext:n},l.id))})})},Ne={OOC:"((ooc: **)) ",USER:"{{user}} ",CHAR:"{{char}} ",ACTION:"((action: **)) ",NEXT:"((next)) "},Kt=({onSend:a,disabled:t=!1,isProcessing:s=!1})=>{const[r,u]=d.useState(""),v=d.useRef(null),w=m=>{const y=Ne[m],n=v.current;if(!n||!y)return;const j=n.selectionStart??r.length,P=n.selectionEnd??r.length;u(l=>{const b=l.slice(0,j)+y+l.slice(P);return requestAnimationFrame(()=>{n.focus();const f=j+y.length;n.setSelectionRange(f,f)}),b})},M=async()=>{const m=r.trim();if(!(!m||t||s))try{await a(m),u("")}finally{requestAnimationFrame(()=>{v.current?.focus()})}};return e.jsxs(Q,{gap:6,children:[e.jsx(G,{gap:4,children:Object.keys(Ne).map(m=>e.jsx(ue,{size:"compact-xs",disabled:t||s,onMouseDown:y=>y.preventDefault(),onClick:()=>w(m),children:m},m))}),e.jsx(G,{gap:"xs",wrap:"nowrap",children:e.jsx(bt,{radius:"lg",autosize:!0,minRows:2,placeholder:"Type your message...",flex:1,value:r,onChange:m=>u(m.currentTarget.value),ref:v,disabled:t||s,onKeyDown:m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),M())},rightSection:e.jsx(ae,{onClick:M,radius:"xl",variant:"light",disabled:t||s||r.trim().length===0,children:s?e.jsx(Le,{size:"xs"}):e.jsx(Ht,{})})})})]})};function ts(){const a=ft.useLoaderData(),{chat:t,activePersona:s,activePreset:r,characters:u,lorebooks:v,branches:w,activeBranchId:M}=a,m=d.useRef(null),y=d.useCallback(()=>{const o=m.current;o&&o.scrollTo({top:o.scrollHeight,behavior:"smooth"})},[]),[n,j]=d.useState(M??null),P=$e(()=>x.chatBranches.where("chatId").equals(t.id).toArray(),[t.id]),l=d.useMemo(()=>[...P??w??[]].sort((c,p)=>c.createdAt-p.createdAt),[P,w]);d.useEffect(()=>{if(!l.length)return;if(!(n?l.some(c=>c.id===n):!1)){const c=l[l.length-1]??l[0];c&&(j(c.id),x.chats.update(t.id,{activeBranchId:c.id}))}},[n,l,t.id]);const b=$e(async()=>n?x.messages.where("chatId").equals(t.id).and(o=>o.branchId===n).toArray():[],[t.id,n],n===M?a.messages:[]),[f,R]=d.useState(()=>u[0]?.id??null);d.useEffect(()=>{!f&&u[0]&&R(u[0].id)},[u,f]);const i=d.useMemo(()=>u.find(o=>o.id===f)??u[0]??null,[u,f]),k=d.useMemo(()=>i?.inChatName?.trim()||i?.name?.trim()||"Assistant",[i]),S=d.useMemo(()=>s?.inChatName?.trim()||s?.name?.trim()||"You",[s]),g=gt(k,S),C=d.useMemo(()=>b?b.length>0:a.messages.length>0,[a.messages.length,b]);d.useEffect(()=>{const o=i;if(!o||C||!o.initMessage?.trim()||!n)return;(async()=>{await x.transaction("rw",x.messages,async()=>{await x.messages.where("chatId").equals(t.id).and(A=>A.branchId===n).count()>0||await x.messages.add({id:K(),role:"assistant",name:o.inChatName??o.name,content:g(o.initMessage),timestamp:Date.now(),chatId:t.id,avatar:o.avatar,branchId:n})})})()},[n,t.id,C,g,i]),d.useEffect(()=>{y()},[n,b?.length,y]);const[$,T]=d.useState(!1),[F,D]=d.useState(null),[_,O]=d.useState(null),J=d.useCallback(o=>{O(o)},[]),H=d.useCallback(()=>{O(null)},[]),ee=d.useCallback(async()=>{const o=_;!o||!n||(await x.transaction("rw",x.messages,async()=>{const p=(await x.messages.where("chatId").equals(t.id).and(h=>h.branchId===n).toArray()).slice().sort((h,E)=>h.timestamp-E.timestamp),A=p.findIndex(h=>h.id===o.id);if(A===-1)return;const B=p.slice(A).map(h=>h.id);await x.messages.bulkDelete(B)}),O(null))},[n,t.id,_]);d.useEffect(()=>{O(null)},[n]);const z=d.useMemo(()=>n?l.findIndex(o=>o.id===n):-1,[n,l]),re=d.useMemo(()=>z===-1||l.length===0?void 0:`${l[z]?.name?.trim()||`Branch ${z+1}`} (${z+1}/${l.length})`,[z,l]),te=z>0,ie=z>=0&&z<l.length-1,U=d.useCallback(async o=>{if(z===-1)return;const c=o==="previous"?z-1:z+1,p=l[c];p&&(j(p.id),O(null),await x.chats.update(t.id,{activeBranchId:p.id}))},[z,l,t.id]),se=d.useCallback(async o=>{if(!n){D("No active branch is available.");return}const c=K();try{await x.transaction("rw",x.chatBranches,x.messages,x.chats,async()=>{const A=`Branch ${(await x.chatBranches.where("chatId").equals(t.id).toArray()).length+1}`;await x.chatBranches.add({id:c,chatId:t.id,name:A,parentBranchId:n,pivotMessageId:o.id,createdAt:Date.now()});const h=(await x.messages.where("chatId").equals(t.id).and(I=>I.branchId===n).toArray()).slice().sort((I,de)=>I.timestamp-de.timestamp),E=h.findIndex(I=>I.id===o.id);if(E===-1)throw new Error("The selected message is no longer available.");const N=h.slice(0,E+1).map(I=>({...I,id:K(),branchId:c}));N.length>0&&await x.messages.bulkAdd(N),await x.chats.update(t.id,{activeBranchId:c})}),j(c),D(null),y()}catch(p){const A=p instanceof Error?p.message:"Failed to create a branch.";D(A)}},[n,t.id,y]),Y=d.useMemo(()=>{const o=[];return r||o.push("activate at least one preset"),u.length===0&&o.push("add a character to this chat"),f||o.push("select which character should answer"),o},[r,u,f]),L=d.useCallback(o=>o?typeof o=="string"?o:Array.isArray(o)?o.map(c=>typeof c=="string"?c:c&&typeof c=="object"&&"text"in c&&typeof c.text=="string"?c.text:"").join(""):"":"",[]),le=d.useCallback(()=>{if(!r)return"You are a helpful AI assistant.";const o=[];if(r.preHistoryInstructions?.trim()&&o.push(`Pre-history instructions:
${g(r.preHistoryInstructions.trim())}`),i&&o.push(`You are roleplaying as "${i.inChatName??i.name}" (internal name: ${i.name}).
Description: ${g(i.description)}
Scenario: ${g(i.scenario)}
Initial message guidance: ${g(i.initMessage)}`),i&&u.length>1){const c=u.filter(p=>p.id!==i.id).map(p=>`${p.inChatName}: ${g(p.description)}`).join(`
`);c&&o.push(`Other characters in this chat:
${c}`)}if(s&&o.push(`The user persona is "${s.inChatName}".
Description: ${s.description}`),r.impersonationPrompt?.trim()&&o.push(`Impersonation prompt:
${g(r.impersonationPrompt.trim())}`),r.postHistoryInstructions?.trim()&&o.push(`Post-history instructions:
${g(r.postHistoryInstructions.trim())}`),v.length>0){const c=v.map(p=>{const A=[p.description?.trim()?`Summary: ${g(p.description)}`:null,g(p.content).trim()].filter(Boolean);return`${p.name}
${A.join(`
`)}`}).join(`

`);o.push(`Relevant lorebooks:
${c}`)}return r.repetitionPenalty!==void 0&&o.push(`Apply an implicit repetition penalty of ${r.repetitionPenalty}.`),o.map(c=>c.trim()).filter(c=>c.length>0).join(`

`)||"You are a helpful AI assistant."},[s,r,u,v,g,i]),W=d.useCallback(async o=>{if(!r)throw new Error("You need to activate a preset before chatting.");const c=le(),p=o.filter(I=>I.role==="user"||I.role==="assistant").map(I=>({role:I.role,content:I.content,name:I.name}));if(p.length===0||p[p.length-1]?.role!=="user")throw new Error("Cannot generate a response without a preceding user message.");const A=[{role:"system",content:c},...p],E=(await(await vt()).chat.send({model:r.model,messages:A,temperature:r.temperature,topP:r.topP,frequencyPenalty:r.frequencyPenalty,presencePenalty:r.presencePenalty,maxTokens:r.maxNewToken}))?.choices?.[0]?.message?.content,N=L(E).trim();if(!N)throw new Error("Model returned an empty response.");return N},[r,le,L]),ce=d.useCallback(async o=>{if($)return;if(!r){D("You need to activate a preset before chatting.");return}if(!i){D("Select a character to respond to your messages.");return}if(!n){D("No active branch is available.");return}T(!0),D(null);const c=Date.now(),p=g(o),A={id:K(),role:"user",name:s?.inChatName??s?.name??"You",content:p,timestamp:c,chatId:t.id,avatar:s?.avatar,branchId:n};try{await x.messages.add(A);const h=(await x.messages.where("chatId").equals(t.id).and(I=>I.branchId===n).toArray()).slice().sort((I,de)=>I.timestamp-de.timestamp),E=await W(h),N={id:K(),role:"assistant",name:i.inChatName??i.name,content:E,timestamp:Date.now(),chatId:t.id,avatar:i.avatar,branchId:n};await x.messages.add(N)}catch(B){const h=B instanceof Error?B.message:"Unexpected error";D(h),await x.messages.add({id:K(),role:"system",name:"System",content:`Failed to fetch a response: ${h}`,timestamp:Date.now(),chatId:t.id,avatar:void 0,branchId:n})}finally{T(!1)}},[s,r,n,t.id,$,W,g,i]),ve=d.useCallback(async o=>{if(!$){if(!r){D("You need to activate a preset before regenerating.");return}if(!i){D("Select a character to respond to your messages.");return}if(!n){D("No active branch is available.");return}T(!0),D(null),O(null);try{const p=(await x.messages.where("chatId").equals(t.id).and(N=>N.branchId===n).toArray()).slice().sort((N,I)=>N.timestamp-I.timestamp),A=p.findIndex(N=>N.id===o.id);if(A===-1)throw new Error("Message to regenerate was not found.");const B=p.slice(0,A),h=await W(B),E={id:K(),role:"assistant",name:i.inChatName??i.name,content:h,timestamp:Date.now(),chatId:t.id,avatar:i.avatar,branchId:n};await x.transaction("rw",x.messages,async()=>{const N=p.slice(A).map(I=>I.id);N.length>0&&await x.messages.bulkDelete(N),await x.messages.add(E)})}catch(c){const p=c instanceof Error?c.message:"Unexpected error";D(p)}finally{T(!1)}}},[r,n,t.id,$,W,i]),Ie=b??a.messages;return e.jsxs(Q,{justify:"space-between",style:{height:"calc(100dvh - 64px - var(--mantine-spacing-md))"},children:[e.jsxs(Q,{gap:"xs",children:[e.jsx(G,{children:u.map(o=>e.jsx(ue,{size:"compact-xs",variant:o.id===i?.id?"filled":"default",onClick:()=>R(o.id),children:o.name},o.id))}),Y.length>0&&e.jsx(he,{variant:"light",color:"yellow",icon:e.jsx(Ae,{size:16}),children:`To start chatting, ${Y.join(", ")}.`}),F&&e.jsx(he,{variant:"light",color:"red",icon:e.jsx(Ae,{size:16}),children:F})]}),e.jsx(Xt,{viewport:m,messages:Ie,characters:u,persona:s,onDeleteMessage:J,onRegenerateMessage:ve,onCreateBranch:se,onNavigateBranch:U,branchLabel:re,canNavigatePrev:te,canNavigateNext:ie}),e.jsxs(Q,{gap:"xs",children:[$&&e.jsxs(G,{gap:"xs",children:[e.jsx(Le,{size:"xs"}),e.jsxs(V,{size:"sm",c:"dimmed",children:[i?.inChatName??"Assistant"," is thinking..."]})]}),e.jsx(Kt,{onSend:ce,disabled:Y.length>0||!n,isProcessing:$})]}),e.jsx(yt,{opened:_!==null,onClose:H,title:"Delete message?",centered:!0,children:e.jsxs(Q,{gap:"sm",children:[e.jsx(V,{size:"sm",children:"Are you sure you want to delete this message? This action cannot be undone."}),e.jsxs(G,{justify:"flex-end",gap:"xs",children:[e.jsx(ue,{variant:"default",onClick:H,children:"Cancel"}),e.jsx(ue,{color:"red",onClick:ee,children:"Delete"})]})]})})]})}export{ts as component};
