import{u as v,R as i,d as r,j as e,G as l,B as t,L as k,M as A,T as m,g as I}from"./index-DaNayWsf.js";import{u as T}from"./dexie-react-hooks-D7kuwoQv.js";import{e as U,F as L,p as M}from"./exportImport-4vIVBYt1.js";import{T as O}from"./Title-CULcuMaJ.js";import{S as f}from"./Stack-3pGxJtfM.js";import{C as G}from"./Card-BkIVK4cG.js";import{A as J}from"./Avatar-6UtTKVdb.js";function Y(){const a=T(()=>r.personas.toArray()),[j,c]=v(),[o,b]=i.useState(null),[P,u]=v(!1),[E,g]=i.useState(!1),[w,x]=i.useState(null),[F,C]=i.useState(""),h=i.useRef(null),S=s=>{b(s),c.open()},N=i.useCallback(async()=>{const s=await r.personas.toArray()??[];U("personas",s)},[]),z=s=>{h.current=s,C(s?s.name:""),x(null)},D=async()=>{if(!h.current){x("Select a JSON file before importing.");return}g(!0),x(null);try{const s=await M("personas",h.current);if(s.length===0)throw new Error("Import file does not contain any personas.");const d=s.map(n=>{const R=typeof n.id=="string"?n.id.trim():"",y=(n.name??"").trim(),B=(n.inChatName??"").trim();return{id:R||I(),name:y||"Unnamed Persona",inChatName:B||y||"User",description:n.description??"",avatar:n.avatar,isActive:!!n.isActive,lorebookIds:Array.isArray(n.lorebookIds)?n.lorebookIds:[]}}),p=new Map;for(const n of d)p.has(n.id)&&(n.id=I(),n.isActive=!1),p.set(n.id,n);await r.transaction("rw",r.personas,async()=>{await r.personas.bulkPut(Array.from(p.values()))}),u.close(),C(""),h.current=null}catch(s){const d=s instanceof Error?s.message:"Failed to import personas.";x(d)}finally{g(!1)}};return e.jsxs(i.Fragment,{children:[e.jsxs(l,{justify:"space-between",align:"end",mb:"md",children:[e.jsx(O,{order:2,children:"Personas"}),e.jsxs(l,{gap:"xs",children:[e.jsx(t,{variant:"default",onClick:N,children:"Export"}),e.jsx(t,{variant:"default",onClick:u.open,children:"Import"}),e.jsx(t,{component:k,to:"/persona/new/",children:"New Persona"})]})]}),e.jsx(f,{gap:"xs",children:a?.map(s=>e.jsx($,{p:s,onDelete:()=>S(s.id),setAsActive:()=>{r.transaction("rw",r.personas,async()=>{const d=await r.personas.toArray();for(const p of d)await r.personas.update(p.id,{isActive:!1});await r.personas.update(s.id,{isActive:!0})})}},s.id))}),e.jsxs(A,{opened:j,onClose:c.close,title:"Delete Persona",children:["Are you sure you want to delete this persona?",e.jsxs(l,{mt:"md",justify:"flex-end",children:[e.jsx(t,{variant:"default",onClick:c.close,children:"Cancel"}),e.jsx(t,{color:"red",onClick:async()=>{o&&await r.personas.delete(o),c.close()},children:"Delete"})]})]}),e.jsx(A,{opened:P,onClose:u.close,title:"Import Personas",children:e.jsxs(f,{children:[e.jsx(m,{size:"sm",children:"Import personas from a JSON export file. Existing personas with the same identifier will be overwritten."}),e.jsxs(l,{justify:"space-between",align:"center",children:[e.jsx(L,{onChange:z,accept:"application/json",children:s=>e.jsx(t,{...s,variant:"default",size:"compact-sm",children:"Choose File"})}),e.jsx(m,{size:"sm",c:"dimmed",children:F||"No file selected"})]}),w&&e.jsx(m,{size:"sm",c:"red",children:w}),e.jsxs(l,{justify:"flex-end",mt:"sm",children:[e.jsx(t,{variant:"default",onClick:u.close,children:"Cancel"}),e.jsx(t,{onClick:D,loading:E,children:"Import"})]})]})})]})}function $({p:a,onDelete:j,setAsActive:c}){return e.jsx(G,{radius:"md",p:"md",withBorder:!0,style:{backdropFilter:"saturate(180%) blur(20px)",backgroundColor:`rgba(0, 0, 0, ${a.isActive?.85:.25})`},onClick:()=>c(),children:e.jsxs(l,{justify:"space-between",children:[e.jsxs(l,{wrap:"nowrap",children:[e.jsx(J,{radius:"xl",src:a.avatar,alt:a.name,size:"lg"}),e.jsxs(f,{gap:4,children:[e.jsx(m,{fw:600,children:a.name}),e.jsxs(m,{size:"sm",c:"dimmed",children:[a.inChatName," (",a.isActive?"Active":"Inactive",")"]})]})]}),e.jsxs(f,{gap:"xs",children:[e.jsx(t,{onClick:o=>{o.stopPropagation()},component:k,to:`/persona/${a.id}`,size:"compact-xs",children:"Edit"}),e.jsx(t,{size:"compact-xs",color:"red",onClick:o=>{o.preventDefault(),o.stopPropagation(),j()},children:"Delete"})]})]})})}export{Y as component};
