import{u as C,R as a,d as i,j as e,G as c,B as s,L as I,T as d,M as y,g as w}from"./index-PeDk-rhE.js";import{u as A}from"./dexie-react-hooks-u3l9CyFs.js";import{e as B,F as P,p as M}from"./exportImport-B_igoMKX.js";import{T as O}from"./Title-DvaKk0VA.js";import{S as f}from"./Stack-BXTpW8x9.js";import{C as U}from"./Card-BA_ut6GK.js";function V(){const l=A(()=>i.lorebooks.toArray()),[h,r]=C(),[m,L]=a.useState(null),[E,p]=C(!1),[F,b]=a.useState(!1),[j,u]=a.useState(null),[S,g]=a.useState(""),x=a.useRef(null),D=o=>{L(o),r.open()},v=a.useCallback(async()=>{const o=await i.lorebooks.toArray()??[];B("lorebooks",o)},[]),z=o=>{x.current=o,g(o?o.name:""),u(null)},N=async()=>{if(!x.current){u("Select a JSON file before importing.");return}b(!0),u(null);try{const o=await M("lorebooks",x.current);if(o.length===0)throw new Error("Import file does not contain any lorebooks.");const n=o.map(t=>{const R=typeof t.id=="string"?t.id.trim():"",T=(t.name??"").trim();return{id:R||w(),name:T||"Untitled Lorebook",description:t.description??"",content:t.content??""}}),k=new Map;for(const t of n)k.has(t.id)&&(t.id=w()),k.set(t.id,t);await i.transaction("rw",i.lorebooks,async()=>{await i.lorebooks.bulkPut(Array.from(k.values()))}),p.close(),g(""),x.current=null}catch(o){const n=o instanceof Error?o.message:"Failed to import lorebooks.";u(n)}finally{b(!1)}};return e.jsxs(a.Fragment,{children:[e.jsxs(c,{justify:"space-between",align:"end",mb:"md",children:[e.jsx(O,{order:2,children:"Lorebooks"}),e.jsxs(c,{gap:"xs",children:[e.jsx(s,{variant:"default",onClick:v,children:"Export"}),e.jsx(s,{variant:"default",onClick:p.open,children:"Import"}),e.jsx(s,{component:I,to:"/lorebook/new/",children:"New Lorebook"})]})]}),e.jsxs(f,{gap:"xs",children:[l?.map(o=>e.jsx(G,{lorebook:o,onDelete:()=>D(o.id)},o.id)),(!l||l.length===0)&&e.jsx(d,{c:"dimmed",children:"No lorebooks yet. Create one to get started."})]}),e.jsxs(y,{opened:h,onClose:r.close,title:"Delete Lorebook",children:["Are you sure you want to delete this lorebook?",e.jsxs(c,{mt:"md",justify:"flex-end",children:[e.jsx(s,{variant:"default",onClick:r.close,children:"Cancel"}),e.jsx(s,{color:"red",onClick:async()=>{m&&(await i.lorebooks.delete(m),await Promise.all([i.personas.toCollection().modify(o=>{o.lorebookIds=(o.lorebookIds||[]).filter(n=>n!==m)}),i.characters.toCollection().modify(o=>{o.lorebookIds=(o.lorebookIds||[]).filter(n=>n!==m)}),i.chats.toCollection().modify(o=>{o.lorebookIds=(o.lorebookIds||[]).filter(n=>n!==m)})])),r.close()},children:"Delete"})]})]}),e.jsx(y,{opened:E,onClose:p.close,title:"Import Lorebooks",children:e.jsxs(f,{children:[e.jsx(d,{size:"sm",children:"Import lorebooks from a JSON export file. Existing lorebooks with the same identifier will be overwritten."}),e.jsxs(c,{justify:"space-between",align:"center",children:[e.jsx(P,{onChange:z,accept:"application/json",children:o=>e.jsx(s,{...o,variant:"default",size:"compact-sm",children:"Choose File"})}),e.jsx(d,{size:"sm",c:"dimmed",children:S||"No file selected"})]}),j&&e.jsx(d,{size:"sm",c:"red",children:j}),e.jsxs(c,{justify:"flex-end",mt:"sm",children:[e.jsx(s,{variant:"default",onClick:p.close,children:"Cancel"}),e.jsx(s,{onClick:N,loading:F,children:"Import"})]})]})})]})}function G({lorebook:l,onDelete:h}){return e.jsx(U,{radius:"md",p:"md",withBorder:!0,style:{backdropFilter:"saturate(180%) blur(20px)",backgroundColor:"rgba(0, 0, 0, 0.3)"},children:e.jsxs(c,{justify:"space-between",align:"start",gap:"md",children:[e.jsxs(f,{gap:4,flex:1,children:[e.jsx(d,{fw:600,children:l.name}),e.jsx(d,{size:"sm",c:"dimmed",children:l.description||"No description"})]}),e.jsxs(f,{gap:"xs",children:[e.jsx(s,{onClick:r=>{r.stopPropagation()},component:I,to:`/lorebook/${l.id}`,size:"compact-xs",children:"Edit"}),e.jsx(s,{size:"compact-xs",color:"red",onClick:r=>{r.preventDefault(),r.stopPropagation(),h()},children:"Delete"})]})]})})}export{V as component};
